apiVersion: apps/v1
kind: Deployment
metadata:
  name: minecraft-proxy
  namespace: minecraft
  labels:
    app: minecraft-proxy
spec:
  selector:
    matchLabels:
      app: minecraft-proxy
  strategy:
    type: Recreate
  replicas: 1
  template:
    metadata:
      labels:
        app: minecraft-proxy
    spec:
      initContainers:
        - name: init-velocity
          image: busybox
          command:
            - /bin/sh
            - -c
            - |
              if [ ! -f /server/velocity.toml ]; then
                wget -O /server/velocity.toml https://raw.githubusercontent.com/PaperMC/Velocity/dev/3.0.0/proxy/src/main/resources/default-velocity.toml
              fi
              if [ ! -f /server/forwarding.secret ]; then
                dd if=/dev/urandom bs=1 count=64 2>/dev/null | base64 > /server/forwarding.secret
              fi
          volumeMounts:
            - name: minecraft-proxy-volume
              mountPath: /server
      containers:
        - name: minecraft-proxy
          image: itzg/bungeecord:java17
          ports:
            - containerPort: 25577
          volumeMounts:
            - name: minecraft-proxy-volume
              mountPath: /server/logs
              subPath: logs
            - name: minecraft-proxy-volume
              mountPath: /server/plugins
              subPath: plugins
            - name: minecraft-proxy-volume
              mountPath: /server/velocity.toml
              subPath: velocity.toml
            - name: minecraft-proxy-volume
              mountPath: /server/forwarding.secret
              subPath: forwarding.secret
          env:
            - name: TYPE
              value: "VELOCITY"
            - name: VELOCITY_VERSION
              value: "3.2.0-SNAPSHOT"
            - name: VELOCITY_BUILD_ID
              value: "276"
            - name: RCON_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rcon-web-secret
                  key: RCON_PASSWORD
      volumes:
        - name: minecraft-proxy-volume
          persistentVolumeClaim:
            claimName: minecraft-proxy-pvc
        - name: secret-volume
          secret:
            secretName: minecraft-proxy-secret
